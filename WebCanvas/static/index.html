<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>Page Title</title>
        <meta charset="UTF-8" />
        <link rel="stylesheet" type="text/css" href="css/index.css">
    </head>
<body>
    <h1>まったりかずあき</h1>

    <form id="room-form" action="/createRoom" method="get" onsubmit="return validateForm()">
        <label for="rname">部屋名</label>
        <input type="text" placeholder="room name" name="roomName" id="rname"><br><br>
        <label for="uname">名前</label>
        <input type="text" placeholder="your name" name="userName" id="uname" ><br><br>
        <input type="submit" value="入室" class="entry_room">

    </form>
<p id="message"></p>
<a href="/canv_only">キャンバスオンリー</a>
<a href="/canv_and_chat">キャンバスとチャット</a>


<div class="container">
    <h1>WebSocket-Chat</h1>
    <form class="form-inline">
        <div class="form-group">
            <label class="roomLabel" for="rooms">部屋：</label>
            <select class="form-control" id="rooms">
                <option value="room01">部屋01</option>
                <option value="room02">部屋02</option>
            </select>
            <label class="nameLabel" for="msgForm">名前：</label>
            <input type="text" class="form-control" id="msgForm">
        </div>
        <button type="button" class="btn btn-primary" id="sendButton" onclick="location.href='/canv_and_chat' ">入室</button>
    </form>
    <div id="chatLogs"></div>
</div>

</body>
<script>
    function validateForm(){
      var rn = document.forms[0]["roomName"].value;
      var un = document.forms[0]["userName"].value;
      var msg = document.getElementById("message");
      var roomMembers = [];
      getNames( rn, roomMembers);
      console.log(roomMembers);
      if ( rn=="" || un=="" ){
        msg.innerHTML="部屋名・名前はうめてね";
        return false;
      } else if (un.length >= 10) {
          msg.innerHTML='名前は10文字以下にしてね(｡-人-｡)';
          return false;
      }else {
          for (var i in roomMembers) {
              if (un == i ){
                  alert("その名前は既にルーム内で使用されてます|ﾉ･ω･)ﾉ⌒(*･-･)");
                  return false;
              }
          }
          console.log("ok!!");
          return true;
      }
    }

    function getNames( roomName , list){
        console.log(roomName);
        const client = require("./db_client").pg_client()
        client.connect()
            .then(() => console.log("Connected successfuly"))
            .then(() => client.query("select names from " + roomName ))
            .then(function (results) {
                console.table(results.rows)
                for(var item of results.rows){
                    list.push(item["names"]);
                }
			})
            .catch((e => console.log(e)))
            .catch((() => client.end()))
        }

    
</script>
</html>

